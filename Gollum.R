#Brutish script that can easily be written better (probably a loop). Since it is so ugly we give it
#a fitting name, Gollum
#setwd("C:/Users/Adam/Application Data/SSH/temp")
#setwd("C:/Users/RunAn/Desktop/outputs")
setwd("C:/Users/Adam B/Desktop/outputs/Fig1/neg6")
library(data.table)
library(ggplot2)
library(rlang)
library(gtools)
library(zoo)
#####
#Potential loop backbone
for (i in 1:3){#pre-expansion size, 1 = 2 indv, 2 = 10 , 3 = 100
  for (j in 2:6){#post-expansion size, 2=10^2, 3=10^3, you get the idea
    for (k in 4:9){#mutation rate: 4= 10^-4, 5=10^-5, righto
     inputfile1<-paste(i,j,k,sep="_")
     inputfile2<-paste(".txt")
     inputfile<-paste0(inputfile1,inputfile2)#these lines just paste together my naming scheme
     infile<-fread(inputfile)#use fread. Its so much faster. Try reading in big files and test the difference
     infile<-infile[,-c(1:6,8:9)]
     infile$TimeBack<-rep(c(0,1000,2000,3000,4000,5000,6000,7000,8000,9000,10000,11000,12000,13000,14000,15000,16000,17000,18000,19000,20000,21000,22000,23000,24000,25000,26000,27000,28000,29000,30000,31000,32000,33000,34000,35000,36000,37000,38000,39000,40000,41000,42000,43000,44000,45000,46000,47000,48000,49000,49050,49100,49150,49200,49250,49300,49350,49400,49450,49500,49550,49600,49650,49700,49750,49800,49850,49900,49910,49920,49930,49940,49950,49960,49970,49980,49990,50000,50010,50020,50030,50040,50050,50060,50070,50080,50081,50082,50083,50084,50085,50086,50087,50088,50089,50090,50091,50092,50093,50094,50095,50096,50097,50098,50099,50100))
     colnames(infile)<-c("Nucleotide Diversity", "TimeBack")
     ijkmean<-aggregate(infile$`Nucleotide Diversity` ~ infile$TimeBack, data=infile, FUN=mean)#this needs to be fixed
     ijkmed<-aggregate(infile$`Nucleotide Diversity` ~ infile$TimeBack, data=infile, FUN=median)#this needs to be fixed
     ijkmean$Logtime<-log10(ijkmean$Timeback)
     ijkmean$LogNuc<-log10(ijkmean$`Nucleotide Diversity`)
     ijkmed$Logtime<-log10(ijkmed$Timeback)
     ijkmed$LogNuc<-log10(ijkmed$`Nucleotide Diversity`)
     colnames(ijkmean)<-c("Timeback","MeanNucDiv","LogTime","LogNuc")
     colnames(ijkmed)<-c("Timeback","MeanNucDiv","LogTime","LogNuc")
    }
  }
}
#####
#Input/graph
output<-fread("Fig1_2_100_neg6")#Fread is best read.

stderror<-output[,9]
output<-output[,-c(1:6)]
output<-output[,-c(2:3)]

#output<-output[-c(1:1000),]
#pdf()
#output$samplingtimes<- rep(c(01,100,200,300,500,600,700,800,900,950,1000,1050,1100,1150,1200,1250,1300,1350,1450,1550,1650,1750,1850,1950,2050,2150,2250,2350,2450,2550,2650,2750),each=500)
output$samplingtimes<-rep(c(50,100,150,200,250,300,350,400,450,500,550,600,650,700,750,800,850,900,950,1000,1050,1100,1150,1200,1250,1300,1350,1400,1450,1500,1550,1600,1650,1700,1750,1800,1850,1900,1950,2000,2050,2100,2150,2200,2250,2300,2350,2400,2450,2500,2550,2600,2650,2700,2750,2800,2850,2900,2950,3000,3050,3100,4100,5100,6100,7100,8100,9100,10100,11100,12100,13100,14100,15100),each=1000)
#output$TimeBack<-rep(c(0,10000,20000,30000,30100,30200,30300,30400,30500,30600,30700,30800,30900,31000,31100,31200,31300,31400,31500,31600,31700,31800,31900,32000,32100,32200,32300,32400,32500,32600,32700,32800,32900,33000,33100,33200,33300,33400,33500,33600,33700,33800,33900,34000,34100,34200,34300,34400,34500,34600,34700,34800,34900,35000,35100,35200,35300,35400,35500,35600,35700,35800,35900,36000,36100,36200,36300,36400,36500,36600,36700,36800,36900,37000,37100,37200,37300,37400,37500,37600,37700,37800,37900,38000,38100,38200,38300,38400,38500,38600,38700,38800,38900,39000,39100,39200,39300,39400,39500,39600,39700,39800,39900,40000,40100,40200,40300,40400,40500,40600,40700,40800,40900,41000,41100,41200,41300,41400,41500,41600,41700,41800,41900,42000,42100,42200,42300,42400,42500,42600,42700,42800,42900,43000,43100,43200,43300,43400,43500,43600,43700,43800,43900,44000,44100,44200,44300,44400,44500,44600,44700,44800,44900,45000,45100,45200,45300,45400,45500,45600,45700,45800,45900,46000,46100,46200,46300,46400,46500,46600,46700,46800,46900,47000,47100,47200,47300,47400,47500,47600,47700,47800,47900,48000,48100,48200,48300,48400,48500,48600,48700,48800,48900,49000,49100,49200,49300,49400,49500,49600,49700,49800,49900,50000,50001,50002,50003,50004,50005,50006,50007,50008,50009,50010,50011,50012,50013,50014,50015,50016,50017,50018,50019,50020,50021,50022,50023,50024,50025,50026,50027,50028,50029,50030,50031,50032,50033,50034,50035,50036,50037,50038,50039,50040,50041,50042,50043,50044,50045,50046,50047,50048,50049,50050,50051,50052,50053,50054,50055,50056,50057,50058,50059,50060,50061,50062,50063,50064,50065,50066,50067,50068,50069,50070,50071,50072,50073,50074,50075,50076,50077,50078,50079,50080,50081,50082,50083,50084,50085,50086,50087,50088,50089,50090,50091,50092,50093,50094,50095,50096,50097,50098,50099,50100,50101))
#output$samplingtimes<-rep(c(16,17,18,19,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190,200,250,300,350,400,450,500,550,600,650,700,750,800,850,900,950,1000,1050,1100,2100,3100,4100,5100,6100,7100,8100,9100,10100,11100,12100,13100,14100,15100,16100,17100,18100,19100,20100,21100,22100,23100,24100,25100,26100,27100,28100,29100,30100,31100,32100,33100,34100,35100,36100,37100,38100,39100,40100,41100,42100,43100,44100,45100,46100,47100,48100,49100,50100),each=1000)
#output$TimeBack<-rep(c(0,10000,20000,20100,20200,20300,20400,20500,20600,20700,20800,20900,21000,21100,21200,21300,21400,21500,21600,21700,21800,21900,22000,22100,22200,22300,22400,22500,22600,22700,22800,22900,23000,23100,23200,23300,23400,23500,23600,23700,23800,23900,24000,24100,24200,24300,24400,24500,24600,24700,24800,24900,25000,25100,25200,25300,25400,25500,25600,25700,25800,25900,26000,26100,26200,26300,26400,26500,26600,26700,26800,26900,27000,27100,27200,27300,27400,27500,27600,27700,27800,27900,28000,28100,28200,28300,28400,28500,28600,28700,28800,28900,29000,29100,29200,29300,29400,29500,29600,29700,29800,29900,30000,30100,30200,30300,30400,30500,30600,30700,30800,30900,31000,31100,31200,31300,31400,31500,31600,31700,31800,31900,32000,32100,32200,32300,32400,32500,32600,32700,32800,32900,33000,33100,33200,33300,33400,33500,33600,33700,33800,33900,34000,34100,34200,34300,34400,34500,34600,34700,34800,34900,35000,35100,35200,35300,35400,35500,35600,35700,35800,35900,36000,36100,36200,36300,36400,36500,36600,36700,36800,36900,37000,37100,37200,37300,37400,37500,37600,37700,37800,37900,38000,38100,38200,38300,38400,38500,38600,38700,38800,38900,39000,39100,39200,39300,39400,39500,39600,39700,39800,39900,40000,40100,40200,40300,40400,40500,40600,40700,40800,40900,41000,41100,41200,41300,41400,41500,41600,41700,41800,41900,42000,42100,42200,42300,42400,42500,42600,42700,42800,42900,43000,43100,43200,43300,43400,43500,43600,43700,43800,43900,44000,44100,44200,44300,44400,44500,44600,44700,44800,44900,45000,45100,45200,45300,45400,45500,45600,45700,45800,45900,46000,46100,46200,46300,46400,46500,46600,46700,46800,46900,47000,47100,47200,47300,47400,47500,47600,47700,47800,47900,48000,48100,48200,48300,48400,48500,48600,48700,48800,48900,49000,49100,49200,49300,49400,49500,49600,49700,49800,49900,50000,50001,50002,50003,50004,50005,50006,50007,50008,50009,50010,50011,50012,50013,50014,50015,50016,50017,50018,50019,50020,50021,50022,50023,50024,50025,50026,50027,50028,50029,50030,50031,50032,50033,50034,50035,50036,50037,50038,50039,50040,50041,50042,50043,50044,50045,50046,50047,50048,50049,50050,50051,50052,50053,50054,50055,50056,50057,50058,50059,50060,50061,50062,50063,50064,50065,50066,50067,50068,50069,50070,50071,50072,50073,50074,50075,50076,50077,50078,50079,50080,50081,50082,50083,50084,50085,50086,50087,50088,50089,50090,50091,50092,50093,50094,50095,50096,50097,50098,50099,50100,50101))
#output$TimeBack<-rep(c(0,100,200,300,400,500,600,700,800,900,1000,1100,1200,1300,1400,1500,1600,1700,1800,1900,2000,2100,2200,2300,2400,2500,2600,2700,2800,2900,3000,3100,3200,3300,3400,3500,3600,3700,3800,3900,4000,4100,4200,4300,4400,4500,4600,4700,4800,4900,5000,5100,5200,5300,5400,5500,5600,5700,5800,5900,6000,6100,6200,6300,6400,6500,6600,6700,6800,6900,7000,7100,7200,7300,7400,7500,7600,7700,7800,7900,8000,8100,8200,8300,8400,8500,8600,8700,8800,8900,9000,9100,9200,9300,9400,9500,9600,9700,9800,9900,10000,10100,10200,10300,10400,10500,10600,10700,10800,10900,11000,11100,11200,11300,11400,11500,11600,11700,11800,11900,12000,12100,12200,12300,12400,12500,12600,12700,12800,12900,13000,13100,13200,13300,13400,13500,13600,13700,13800,13900,14000,14100,14200,14300,14400,14500,14600,14700,14800,14900,15000,15100,15200,15300,15400,15500,15600,15700,15800,15900,16000,16100,16200,16300,16400,16500,16600,16700,16800,16900,17000,17100,17200,17300,17400,17500,17600,17700,17800,17900,18000,18100,18200,18300,18400,18500,18600,18700,18800,18900,19000,19100,19200,19300,19400,19500,19600,19700,19800,19900,20000,20100,20200,20300,20400,20500,20600,20700,20800,20900,21000,21100,21200,21300,21400,21500,21600,21700,21800,21900,22000,22100,22200,22300,22400,22500,22600,22700,22800,22900,23000,23100,23200,23300,23400,23500,23600,23700,23800,23900,24000,24100,24200,24300,24400,24500,24600,24700,24800,24900,25000,25100,25200,25300,25400,25500,25600,25700,25800,25900,26000,26100,26200,26300,26400,26500,26600,26700,26800,26900,27000,27100,27200,27300,27400,27500,27600,27700,27800,27900,28000,28100,28200,28300,28400,28500,28600,28700,28800,28900,29000,29100,29200,29300,29400,29500,29600,29700,29800,29900,30000,30100,30200,30300,30400,30500,30600,30700,30800,30900,31000,31100,31200,31300,31400,31500,31600,31700,31800,31900,32000,32100,32200,32300,32400,32500,32600,32700,32800,32900,33000,33100,33200,33300,33400,33500,33600,33700,33800,33900,34000,34100,34200,34300,34400,34500,34600,34700,34800,34900,35000,35100,35200,35300,35400,35500,35600,35700,35800,35900,36000,36100,36200,36300,36400,36500,36600,36700,36800,36900,37000,37100,37200,37300,37400,37500,37600,37700,37800,37900,38000,38100,38200,38300,38400,38500,38600,38700,38800,38900,39000,39100,39200,39300,39400,39500,39600,39700,39800,39900,40000,40100,40200,40300,40400,40500,40600,40700,40800,40900,41000,41100,41200,41300,41400,41500,41600,41700,41800,41900,42000,42100,42200,42300,42400,42500,42600,42700,42800,42900,43000,43100,43200,43300,43400,43500,43600,43700,43800,43900,44000,44100,44200,44300,44400,44500,44600,44700,44800,44900,45000,45100,45200,45300,45400,45500,45600,45700,45800,45900,46000,46100,46200,46300,46400,46500,46600,46700,46800,46900,47000,47100,47200,47300,47400,47500,47600,47700,47800,47900,48000,48100,48200,48300,48400,48500,48600,48700,48800,48900,49000,49100,49200,49300,49400,49500,49600,49700,49800,49900,50000,50001,50002,50003,50004,50005,50006,50007,50008,50009,50010,50011,50012,50013,50014,50015,50016,50017,50018,50019,50020,50021,50022,50023,50024,50025,50026,50027,50028,50029,50030,50031,50032,50033,50034,50035,50036,50037,50038,50039,50040,50041,50042,50043,50044,50045,50046,50047,50048,50049,50050,50051,50052,50053,50054,50055,50056,50057,50058,50059,50060,50061,50062,50063,50064,50065,50066,50067,50068,50069,50070,50071,50072,50073,50074,50075,50076,50077,50078,50079,50080,50081,50082,50083,50084,50085,50086,50087,50088,50089,50090,50091,50092,50093,50094,50095,50096,50097,50098,50099,50100,50101))
#output$TimeBack<-rep(c(0,1000,2000,3000,4000,5000,6000,7000,8000,9000,10000,11000,12000,13000,14000,15000,16000,17000,18000,19000,20000,21000,22000,23000,24000,25000,26000,27000,28000,29000,30000,31000,32000,33000,34000,35000,36000,37000,38000,39000,40000,41000,42000,43000,44000,45000,46000,47000,48000,49000,49050,49100,49150,49200,49250,49300,49350,49400,49450,49500,49550,49600,49650,49700,49750,49800,49850,49900,49940,49941,49942,49943,49944,49945,49946,49947,49948,49949,49950,49951,49952,49953,49954,49955,49956,49957,49958,49959,49960,49961,49962,49963,49964,49965,49966,49967,49968,49969,49970,49971,49972,49973,49974,49975,49976,49977,49978,49979,49980,49981,49982,49983,49984,49985,49986,49987,49988,49989,49990,49991,49992,49993,49994,49995,49996,49997,49998,49999,50000,50010,50020,50030,50040,50050,50055,50065,50066,50067,50068,50069,50070,50071,50072,50073,50074,50075,50076,50077,50078,50079,50080,50081,50082,50083,50084,50085,50086,50087,50088,50089,50090,50091,50092,50093,50094,50095,50096,50097,50098,50099,50100,50101))
#output$TimeBack<-rep(c(0,1000,2000,3000,4000,5000,6000,7000,8000,9000,10000,11000,12000,13000,14000,15000,16000,17000,18000,19000,20000,21000,22000,23000,24000,25000,26000,27000,28000,29000,30000,31000,32000,33000,34000,35000,36000,37000,38000,39000,40000,41000,42000,43000,44000,45000,46000,47000,48000,49000,49050,49100,49150,49200,49250,49300,49350,49400,49450,49500,49550,49600,49650,49700,49750,49800,49850,49900,49910,49920,49930,49940,49950,49960,49970,49980,49990,50000,50010,50020,50030,50040,50050,50060,50070,50080,50081,50082,50083,50084,50085,50086,50087,50088,50089,50090,50091,50092,50093,50094,50095,50096,50097,50098,50099,50100))
#output$Timeback<-rep(seq(49600,48000,-10), each=250)
#colnames(output)<-c( "Time","Nucleotide Diversity")
colnames(output)<-c("Nucleotide Diversity","Time")

#colnames(output)<-c( "Time","Haps")
#colnames(output)<-c( "Haps","Time")

#str(output)
Nucmean<-aggregate(output$`Nucleotide Diversity` ~ output$Time, data=output, FUN=mean)
Nucmean$StdDev<-aggregate(output$StdDev ~ output$Time, data=output, FUN=mean)
Nucmean$Error<-(Nucmean$StdDev/sqrt(1000))
#Hapsmean<-aggregate(output$Haps ~ output$Time, data=output, FUN=mean)
#Nucmed10k<-aggregate(output$`Nucleotide Diversity` ~ output$TimeBack, data=output, FUN=median)

#point.zero<-as.data.frame(0)
#point.zero$MeanNucDiv<-0
#colnames(point.zero)<-c("Time","MeanNucDiv")
#colnames(Nucmean)<-c("Time","MeanNucDiv")
#testing<-rbind(point.zero,Fig1_100_500_neg5)
Fig1_100_500_neg5<-Nucmean
#colnames(Hapsmean)<-c( "Time","Haps")

combined<-rbind(Nucmean,Fig1_100_1k_neg8[,1:2])
Nucmean<-aggregate(combined$MeanNucDiv ~ combined$Time, data=combined, FUN=mean)
#####
#Nucmean<-Nucmean[mixedorder(Nucmean$Time),]
#Hapsmean<-Hapsmean[mixedorder(Hapsmean$Time),]
#Nucmean$Time<-c(16,17,18,19,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190,200,250,300,350,400,450,500,550,600,650,700,750,800,850,900,950,1000,1050,1100,2100,3100,4100,5100,6100,7100,8100,9100,10100,11100,12100,13100,14100,15100,16100,17100,18100,19100,20100,21100,22100,23100,24100,25100,26100,27100,28100,29100,30100,31100,32100,33100,34100,35100,36100,37100,38100,39100,40100,41100,42100,43100,44100,45100,46100,47100,48100,49100,50100)
#Hapsmean$Time<-c(16,17,18,19,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190,200,250,300,350,400,450,500,550,600,650,700,750,800,850,900,950,1000,1050,1100,2100,3100,4100,5100,6100,7100,8100,9100,10100,11100,12100,13100,14100,15100,16100,17100,18100,19100,20100,21100,22100,23100,24100,25100,26100,27100,28100,29100,30100,31100,32100,33100,34100,35100,36100,37100,38100,39100,40100,41100,42100,43100,44100,45100,46100,47100,48100,49100,50100)

Nucmean_2_100000_7<-Nucmean
Hapsmean_2_100000_7<-Hapsmean
Nucmean_2_100_7<-Nucmean
Hapsmean_2_100_7<-Hapsmean
Nucmean_2_1000_7<-Nucmean
Hapsmean_2_1000_7<-Hapsmean
Nucmean_2_10000_7<-Nucmean
Hapsmean_2_10000_7<-Hapsmean

Nucmean_2_1000_7_3x2<-Nucmean

regme<-Hapsmean[52:106,]
Hapsmean_2_10000_7_reg_coal<-lm(regme$Haps~regme$Time,data=regme)
plot(Hapsmean,main=paste('y =', coef(Hapsmean_2_10000_7_reg_coal)[[2]], '* x', '+', coef(Hapsmean_2_10000_7_reg_coal)[[1]]))
abline(Hapsmean_2_1000_7_reg_coal,col="purple")

regme<-Nucmean[52:106,]
Nucmean_2_10000_7_reg_coal<-lm(regme$MeanNucDiv~regme$Time,data=regme)
plot(Nucmean,main=paste('y =', coef(Nucmean_2_10000_7_reg_coal)[[2]], '* x', '+', coef(Nucmean_2_10000_7_reg_coal)[[1]]))
abline(Nucmean_2_1000_7_reg_coal,col="purple")
#colnames(Nucmed10k)<-c("Timeback","MedNucDiv")
#Nucmean10k$Logtime<-log10(Nucmean27$Timeback)


Nucmean[order(sub("\\d+", "", Nucmean[,1]), as.numeric(sub("\\D+", "", Nucmean[,1])), Nucmean[,2] == ""),]


regtest=lm(Hapsmean_2_100_7$Haps~Hapsmean_2_100_7$Time, data = Hapsmean_2_100_7[1:40,])
regtest2=lm(Nucmean_2_100_7$MeanNucDiv~Nucmean_2_100_7$Time, data = Nucmean_2_100_7)

#####
#Regression model below (not sure how it works)

coef(lm(logit(MeanNucDiv/.0003)~Time,data=Fig1_100_5k_neg7))#.00044 is the asymptote (give or take)            
wilson<-nls(MeanNucDiv~phi1/(1+exp(-(phi2+phi3*Time))),
            start=list(phi1=0.0003,phi2=-2.4380503722,phi3=0.0002373834),data=Fig1_100_5k_neg7,trace=TRUE)

phi1<-coef(wilson)[1]
phi2<-coef(wilson)[2]
phi3<-coef(wilson)[3]
x<-c(0:max(Fig1_100_5k_neg7$Time)) #construct a range of x values bounded by the data
y<-phi1/(1+exp(-(phi2+phi3*x))) #predicted mass
predict<-data.frame(x,y) #create the prediction data frame#And add a nice plot (I cheated and added the awesome inset jpg in another program)
ggplot(data=Fig1_100_5k_neg7,aes(x=LogTime,y=MeanNucDiv))+
  geom_point(color='blue',size=5)+theme_bw()+
  labs(x='Time',y='Mean Nuc Div')+
  theme(axis.text=element_text(size=18),axis.title=element_text(size=24))+
  geom_line(data=predict,aes(x=x,y=y), size=3)


######
plot(diff(Fig1_2_100_neg7$MeanNucDiv)/diff(Fig1_2_100_neg7$Time))#This plots the differences between every timepoint
#calc std deviations across all points or 
sandbox<-as.data.frame(diff(neg8recomb_nucmean$MeanNucDiv)/diff(neg8recomb_nucmean$Time))
sandbox$Index<-1:73
regtest<-lm(sandbox$`diff(neg8recomb_nucmean$MeanNucDiv)/diff(neg8recomb_nucmean$Time)`~sandbox$Index,data=sandbox)
plot(sandbox$Index,sandbox$`diff(neg8recomb_nucmean$MeanNucDiv)/diff(neg8recomb_nucmean$Time)`)
abline(regtest)
lm_eqn(regtest)
text(5,0, "y=1.8E-7-2.8E-9*x   R^2=.336")



plot(rollmean((diff(Fig1_2_100_neg7$MeanNucDiv)/diff(Fig1_2_100_neg7$Time)),k=50))

#Below is puttng together each part of Fig1
#####
plot(Fig1_100_1k_neg5$Time,Fig1_100_10k_neg5$MeanNucDiv, pch=19,ylim=c(0,0.1),main="100 Individuals 1E-5 Mutation",xlab="Time",ylab="Mean Nucleotide Diversity")
points(Fig1_100_5k_neg5$Time,Fig1_100_5k_neg5$MeanNucDiv, pch=18, col="red")
points(Fig1_100_1k_neg5$Time,Fig1_100_1k_neg5$MeanNucDiv, pch=17, col="blue")
points(Fig1_100_500_neg5$Time,Fig1_100_500_neg5$MeanNucDiv, pch=15, col="green")
legend("topleft",c("10000","5000","1000","500"),pch=c(19,18,17,15),col=c("black","red","blue","green"))


#### Histogram maker
hist(as.vector(output[output$V1 == "13100GV200.res/13100GV200.xml:143:Nucleotide", "V7"]))

makehisto3<-aframe(output[output$V1 == "13100GV200.res/13100GV200.xml:143:Nucleotide", "V7"])
class(makehisto3)


makehisto<-function (Dataset, TimeRange){
  #grab values with ID = Timerange
  #hist()
  
}
